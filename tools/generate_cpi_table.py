import re
from collections import defaultdict

def extract_cpi_from_text(text, warp_num):
    """从文本中提取CPI数据"""
    data = {}
    lines = text.strip().split('\n')
    in_table = False
    
    for line in lines:
        if "[Throughput CPI]" in line:
            in_table = True
            continue
        
        if in_table and "OPCODE" in line and "COUNT" in line:
            continue
        
        if in_table and line.strip():
            if line.strip().startswith('['):
                break
            
            parts = re.split(r'\s+', line.strip())
            if len(parts) >= 3:
                opcode = parts[0]
                avg_cpi = float(parts[4])
                data[opcode] = avg_cpi
        elif in_table and not line.strip():
            break
    
    return data

def parse_multiple_warp_outputs(output_texts):
    """解析多个warp的输出文本"""
    all_data = {}
    all_opcodes = set()
    
    for warp_num, text in output_texts:
        data = extract_cpi_from_text(text, warp_num)
        all_data[warp_num] = data
        all_opcodes.update(data.keys())
    
    # 生成汇总表格
    sorted_opcodes = sorted(list(all_opcodes))
    warp_nums = sorted(all_data.keys())
    
    print(f"{'OPCODE':<20}", end="")
    for w in warp_nums:
        print(f" Warp_{w:<5}", end="")
    print()
    print("-" * (20 + len(warp_nums) * 12))
    
    for opcode in sorted_opcodes:
        print(f"{opcode:<20}", end="")
        for w in warp_nums:
            avg_cpi = all_data[w].get(opcode, "-")
            if avg_cpi == "-":
                print(f"   {'-':<8}", end="")
            else:
                print(f"   {avg_cpi:<8.2f}", end="")
        print()

# 使用示例
if __name__ == "__main__":
    warp_outputs = [
        (0, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2      10.50      10.50    10.00    11.00
ADDI               524322       2.55       2.00     1.00    14.00
AUIPC              624683       5.86       2.00     1.00   182.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.19       9.00     4.00    18.00
CSRRS                   9      90.78       6.00     4.00   754.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.94       1.00     0.00    44.00
JALR                   12       3.42       2.50     1.00    11.00
JOIN               100388       8.67       7.00     2.00    17.00
LUI                 67585       5.26       8.00     1.00    15.00
LW                  67610     254.22     204.00     2.00  1892.00
MUL                     3       9.00       9.00     8.00    10.00
SETRPC             624678       6.35       6.00     3.00    11.00
SW                     13      25.08       4.00     2.00   168.00
VADD12_VI          558112      10.73      13.00     1.00    19.00
VADD_VI            524288       3.53       3.00     1.00    16.00
VADD_VV            624675       5.37       5.00     2.00    19.00
VADD_VX            623622      19.84      11.00     1.00  1792.00
VAND_VV             66560      12.57      13.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.98      12.00     1.00    15.00
VID_V                   2       6.50       6.50     5.00     8.00
VLW12_V           1114112      17.24       5.00     1.00  1859.00
VLW_V                   1      10.00      10.00    10.00    10.00
VMADD_VX            32768      11.12      11.00    11.00    13.00
VMSLT_VX           133120      11.87      10.50     1.00    30.00
VMUL_VX                64       7.00       6.50     3.00    12.00
VREMU_VX                2       9.00       9.00     8.00    10.00
VSETVLI                 1       6.00       6.00     6.00     6.00
VSLL_VI             66564       8.07       8.00     4.00    10.00
VSW12_V             66560       5.11       5.00     4.00     7.00
VSW_V                   1      12.00      12.00    12.00    12.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.44       1.00     1.00     2.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     262.51     212.00     1.00  1900.00
SETRPC             624678       1.90       2.00     1.00     6.00
VLW12_V           1114112      14.25       1.00     1.00  1863.00
VLW_V                   1    2870.00    2870.00  2870.00  2870.00
"""),
        
        (1, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2      10.50      10.50    10.00    11.00
ADDI               524322       2.55       2.00     1.00    12.00
AUIPC              624683       6.05       2.00     1.00   185.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.20       9.00     4.00    17.00
CSRRS                   9       6.67       6.00     4.00    10.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.99       1.00     0.00    20.00
JALR                   12       3.17       1.00     1.00    13.00
JOIN               100388       8.49       7.00     3.00    17.00
LUI                 67585       4.87       2.00     1.00    15.00
LW                  67610     273.59     260.00     2.00  1937.00
MUL                     3       9.00       9.00     8.00    10.00
SETRPC             624678       6.21       6.00     3.00    11.00
SW                     13       8.38       4.00     4.00    38.00
VADD12_VI          558112      10.49      13.00     1.00    20.00
VADD_VI            524288       3.75       3.00     1.00    16.00
VADD_VV            624675       5.34       5.00     2.00    19.00
VADD_VX            623622      20.61      11.00     8.00  1879.00
VAND_VV             66560      12.50      12.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.79      12.00     1.00    15.00
VID_V                   2       6.50       6.50     6.00     7.00
VLW12_V           1114112      15.66       5.00     1.00  1687.00
VLW_V                   1      13.00      13.00    13.00    13.00
VMADD_VX            32768      11.19      11.00    11.00    13.00
VMSLT_VX           133120      12.31      10.50     1.00    30.00
VMUL_VX                64       6.62       6.50     4.00    12.00
VREMU_VX                2      10.00      10.00     9.00    11.00
VSETVLI                 1       6.00       6.00     6.00     6.00
VSLL_VI             66564       8.13       8.00     4.00    12.00
VSW12_V             66560       5.21       5.00     4.00     9.00
VSW_V                   1     120.00     120.00   120.00   120.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.78       2.00     1.00     3.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     281.91     268.00     1.00  1945.00
SETRPC             624678       1.85       2.00     1.00     5.00
VLW12_V           1114112      12.67       2.00     1.00  1702.00
VLW_V                   1    2731.00    2731.00  2731.00  2731.00
"""),

        (2, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       6.00       6.00     6.00     6.00
ADDI               524322       2.56       2.00     1.00    10.00
AUIPC              624683       6.02       2.00     1.00    62.00
BEQ                     1       7.00       7.00     7.00     7.00
BGE                  1057       9.16       9.00     4.00    17.00
CSRRS                   9       6.67       6.00     3.00    10.00
CSRRW                   1       8.00       8.00     8.00     8.00
JAL               1186008       5.99       1.00     0.00    20.00
JALR                   12       2.67       2.00     1.00    10.00
JOIN               100388       8.52       7.00     2.00    17.00
LUI                 67585       4.93       6.00     1.00    15.00
LW                  67610     276.40     260.00     3.00  1944.00
MUL                     3       8.67       8.00     8.00    10.00
SETRPC             624678       6.21       6.00     3.00    11.00
SW                     13      41.85       4.00     4.00   307.00
VADD12_VI          558112      10.53      13.00     1.00    20.00
VADD_VI            524288       3.73       3.00     1.00    16.00
VADD_VV            624675       5.34       5.00     2.00    19.00
VADD_VX            623622      21.11      11.00     8.00  1879.00
VAND_VV             66560      12.50      12.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.80      12.00     1.00    15.00
VID_V                   2       5.00       5.00     5.00     5.00
VLW12_V           1114112      15.21       5.00     1.00  1664.00
VLW_V                   1      17.00      17.00    17.00    17.00
VMADD_VX            32768      11.22      11.00    11.00    13.00
VMSLT_VX           133120      12.28      10.50     1.00    30.00
VMUL_VX                64       6.41       6.50     4.00    12.00
VREMU_VX                2       8.50       8.50     8.00     9.00
VSETVLI                 1       7.00       7.00     7.00     7.00
VSLL_VI             66564       8.13       8.00     4.00    12.00
VSW12_V             66560       5.20       5.00     4.00     9.00
VSW_V                   1       9.00       9.00     9.00     9.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.33       1.00     1.00     2.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     284.74     268.00     1.00  1949.00
SETRPC             624678       1.85       2.00     1.00     5.00
VLW12_V           1114112      12.23       2.00     1.00  1666.00
VLW_V                   1    2650.00    2650.00  2650.00  2650.00
"""),
        
        (3, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       6.00       6.00     6.00     6.00
ADDI               524322       2.55       2.00     1.00    39.00
AUIPC              624683       6.21       2.00     1.00    62.00
BEQ                     1       7.00       7.00     7.00     7.00
BGE                  1057       9.14       9.00     1.00    18.00
CSRRS                   9       6.33       6.00     3.00    11.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.96       1.00     0.00    20.00
JALR                   12       3.17       2.00     1.00    11.00
JOIN               100388       8.70       7.00     2.00    38.00
LUI                 67585       4.84       1.00     1.00    15.00
LW                  67610     253.78     213.00     1.00  1895.00
MUL                     3       8.67       8.00     8.00    10.00
SETRPC             624678       6.41       6.00     3.00    11.00
SW                     13      51.54       4.00     4.00   276.00
VADD12_VI          558112      10.43      13.00     1.00    19.00
VADD_VI            524288       3.74       3.00     1.00    16.00
VADD_VV            624675       5.32       5.00     2.00    19.00
VADD_VX            623622      25.42      10.00     8.00  2005.00
VAND_VV             66560      12.71      13.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.72      12.00     1.00    15.00
VID_V                   2       4.50       4.50     4.00     5.00
VLW12_V           1114112      14.09       5.00     1.00  1804.00
VLW_V                   1       3.00       3.00     3.00     3.00
VMADD_VX            32768      11.16      11.00    11.00    13.00
VMSLT_VX           133120      11.96      10.50     1.00    30.00
VMUL_VX                64       6.03       6.00     3.00    10.00
VREMU_VX                2       8.50       8.50     8.00     9.00
VSETVLI                 1       7.00       7.00     7.00     7.00
VSLL_VI             66564       8.10       8.00     4.00    10.00
VSW12_V             66560       5.30       5.00     4.00    12.00
VSW_V                   1       9.00       9.00     9.00     9.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.56       1.00     1.00     3.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     262.19     221.00     1.00  1903.00
SETRPC             624678       1.98       2.00     1.00     5.00
VLW12_V           1114112      11.09       1.00     1.00  1819.00
VLW_V                   1    2582.00    2582.00  2582.00  2582.00
"""),

        (4, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       9.00       9.00     7.00    11.00
ADDI               524322       2.56       2.00     1.00    94.00
AUIPC              624683       6.23       2.00     1.00   344.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.17       9.00     5.00    18.00
CSRRS                   9      12.56       5.00     4.00    51.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.96       1.00     0.00   501.00
JALR                   12       3.25       2.00     1.00    13.00
JOIN               100388       8.70       7.00     2.00    17.00
LUI                 67585       4.81       1.00     1.00    15.00
LW                  67610     253.87     213.00     1.00  1897.00
MUL                     3       9.33       9.00     8.00    11.00
SETRPC             624678       6.41       6.00     3.00    11.00
SW                     13      22.46       4.00     4.00   202.00
VADD12_VI          558112      10.43      13.00     1.00    20.00
VADD_VI            524288       3.75       3.00     1.00    16.00
VADD_VV            624675       5.33       5.00     2.00    19.00
VADD_VX            623622      25.61      10.00     1.00  2136.00
VAND_VV             66560      12.71      13.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.71      12.00     1.00    16.00
VID_V                   2       6.00       6.00     6.00     6.00
VLW12_V           1114112      13.96       5.00     1.00  1703.00
VLW_V                   1      11.00      11.00    11.00    11.00
VMADD_VX            32768      11.17      11.00    11.00    13.00
VMSLT_VX           133120      11.97      10.50     1.00    30.00
VMUL_VX                64       6.06       6.00     3.00    10.00
VREMU_VX                2       9.50       9.50     9.00    10.00
VSETVLI                 1       6.00       6.00     6.00     6.00
VSLL_VI             66564       8.10       8.00     4.00    10.00
VSW12_V             66560       5.31       5.00     4.00     9.00
VSW_V                   1     759.00     759.00   759.00   759.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.33       1.00     1.00     2.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     262.28     221.00     1.00  1906.00
SETRPC             624678       1.99       2.00     1.00     5.00
VLW12_V           1114112      10.96       1.00     1.00  1706.00
VLW_V                   1    2945.00    2945.00  2945.00  2945.00
"""),
        
        (5, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       9.00       9.00     7.00    11.00
ADDI               524322       2.49       2.00     1.00    33.00
AUIPC              624683       5.84       2.00     1.00   181.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.18       9.00     3.00    18.00
CSRRS                   9       7.33       7.00     4.00    14.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.94       1.00     0.00    20.00
JALR                   12       3.17       2.00     1.00    11.00
JOIN               100388       8.51       7.00     2.00    17.00
LUI                 67585       4.94       6.00     1.00    15.00
LW                  67610     278.08     254.00     4.00  1982.00
MUL                     3       8.33       8.00     8.00     9.00
SETRPC             624678       6.27       6.00     3.00    11.00
SW                     13      24.46       4.00     4.00   159.00
VADD12_VI          558112      10.82      13.00     1.00    20.00
VADD_VI            524288       3.73       3.00     1.00    16.00
VADD_VV            624675       5.31       5.00     2.00    29.00
VADD_VX            623622      20.35      11.00     8.00  2128.00
VAND_VV             66560      12.47      12.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.85      12.00     1.00    15.00
VID_V                   2       4.50       4.50     4.00     5.00
VLW12_V           1114112      15.55       5.00     1.00  1696.00
VLW_V                   1       2.00       2.00     2.00     2.00
VMADD_VX            32768      11.14      11.00    11.00    13.00
VMSLT_VX           133120      12.23      10.50     1.00    30.00
VMUL_VX                64       6.39       6.50     3.00    12.00
VREMU_VX                2       8.50       8.50     8.00     9.00
VSETVLI                 1       6.00       6.00     6.00     6.00
VSLL_VI             66564       8.07       8.00     4.00    12.00
VSW12_V             66560       5.17       5.00     4.00     9.00
VSW_V                   1      26.00      26.00    26.00    26.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.78       2.00     1.00     3.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     286.37     262.00     1.00  1990.00
SETRPC             624678       1.87       2.00     1.00     5.00
VLW12_V           1114112      12.55       1.00     1.00  1698.00
VLW_V                   1    2563.00    2563.00  2563.00  2563.00
"""),

        (6, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       6.50       6.50     6.00     7.00
ADDI               524322       2.49       2.00     1.00    10.00
AUIPC              624683       5.86       2.00     1.00   182.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.21       9.00     3.00    18.00
CSRRS                   9      93.67       6.00     4.00   795.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.94       1.00     0.00    20.00
JALR                   12       2.67       1.50     1.00    11.00
JOIN               100388       8.50       7.00     2.00    17.00
LUI                 67585       4.94       6.00     1.00    15.00
LW                  67610     278.67     248.00     1.00  1906.00
MUL                     3       8.67       8.00     8.00    10.00
SETRPC             624678       6.27       6.00     3.00    14.00
SW                     13      18.62       4.00     4.00   143.00
VADD12_VI          558112      10.79      13.00     1.00    20.00
VADD_VI            524288       3.74       3.00     1.00    16.00
VADD_VV            624675       5.31       5.00     2.00    19.00
VADD_VX            623622      20.81      11.00     8.00  2065.00
VAND_VV             66560      12.46      13.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.84      12.00     1.00    15.00
VID_V                   2       4.50       4.50     4.00     5.00
VLW12_V           1114112      15.25       5.00     1.00  1627.00
VLW_V                   1       1.00       1.00     1.00     1.00
VMADD_VX            32768      11.15      11.00    11.00    13.00
VMSLT_VX           133120      12.23      10.50     1.00    30.00
VMUL_VX                64       6.47       6.50     3.00    12.00
VREMU_VX                2       8.50       8.50     8.00     9.00
VSETVLI                 1       5.00       5.00     5.00     5.00
VSLL_VI             66564       8.08       8.00     1.00    12.00
VSW12_V             66560       5.18       5.00     4.00     9.00
VSW_V                   1       8.00       8.00     8.00     8.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.78       2.00     1.00     3.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     286.98     256.00     1.00  1916.00
SETRPC             624678       1.88       2.00     1.00     7.00
VLW12_V           1114112      12.25       1.00     1.00  1645.00
VLW_V                   1    2809.00    2809.00  2809.00  2809.00
"""),
        
        (7, """[Throughput CPI] ns_per_cycle=10 ns
OPCODE              COUNT    AVG_CPI    MED_CPI      MIN      MAX
ADD                     2       6.50       6.50     6.00     7.00
ADDI               524322       2.55       2.00     1.00    40.00
AUIPC              624683       5.91       2.00     1.00   181.00
BEQ                     1       6.00       6.00     6.00     6.00
BGE                  1057       9.18       9.00     5.00    18.00
CSRRS                   9       7.44       6.00     4.00    18.00
CSRRW                   1       5.00       5.00     5.00     5.00
JAL               1186008       5.94       1.00     0.00    20.00
JALR                   12       2.67       1.00     1.00    11.00
JOIN               100388       8.67       7.00     2.00    17.00
LUI                 67585       5.28       8.00     1.00    15.00
LW                  67610     250.52     204.00     2.00  1883.00
MUL                     3       9.67      10.00     8.00    11.00
SETRPC             624678       6.36       6.00     3.00    11.00
SW                     13      61.85       4.00     4.00   716.00
VADD12_VI          558112      10.70      13.00     1.00    20.00
VADD_VI            524288       3.52       3.00     1.00    16.00
VADD_VV            624675       5.36       5.00     2.00    19.00
VADD_VX            623622      20.71      11.00     8.00  1783.00
VAND_VV             66560      12.54      13.00     1.00    15.00
VDIVU_VX                1       9.00       9.00     9.00     9.00
VFMADD_VV          524288      10.98      12.00     1.00    15.00
VID_V                   2       5.00       5.00     5.00     5.00
VLW12_V           1114112      16.97       5.00     1.00  1975.00
VLW_V                   1      20.00      20.00    20.00    20.00
VMADD_VX            32768      11.12      11.00    11.00    13.00
VMSLT_VX           133120      11.85      10.50     1.00    30.00
VMUL_VX                64       6.42       6.50     3.00    12.00
VREMU_VX                2       7.00       7.00     2.00    12.00
VSETVLI                 1       5.00       5.00     5.00     5.00
VSLL_VI             66564       8.07       8.00     4.00    10.00
VSW12_V             66560       5.11       5.00     4.00     7.00
VSW_V                   1       8.00       8.00     8.00     8.00

[Latency issue->done] ns_per_cycle=10 ns (仅统计 latency>0 的指令)
OPCODE              COUNT    AVG_LAT    MED_LAT      MIN      MAX
CSRRS                   9       1.44       1.00     1.00     2.00
CSRRW                   1       1.00       1.00     1.00     1.00
LW                  67610     258.82     212.00     1.00  1891.00
SETRPC             624678       1.91       2.00     1.00     5.00
VLW12_V           1114112      13.98       1.00     1.00  1990.00
VLW_V                   1    2740.00    2740.00  2740.00  2740.00""")
    ]
    
    parse_multiple_warp_outputs(warp_outputs)